<html>
<head>
    <title>JS.LA Chat</title>
    <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
    <script type='text/javascript'
        src='https://cdn.firebase.com/js/simple-login/1.4.1/firebase-simple-login.js'></script>
    <link rel="stylesheet" href="css/main.css"></link>
</head>
<body>


<div id="stream">
	<h1>JS.LA Chat</h1>
	<input type="text" id="msgInput" placeholder="Your Message..."/>
<button type="submit" id="tweet-submit">Submit</button>
</div>

<div id="here">
<h1>Who's here?!<a href="#" id="login"><img src="twitter.png"/>Sign in With Twitter</a></h1>
</div>
<script>

	//STEP 1: Define Firebase references
	var ref = new Firebase("https://jsla.firebaseio.com/");
	var usersRef = ref.child("users");
	var messagesRef = ref.child("messages");
	var currentUser = null;

	//STEP 2: Log user in when login button is clicked
	$('#login').on("click", function () {
		auth.login('twitter');
	});

	//STEP 3: Login with Twitter
	var auth = new FirebaseSimpleLogin(ref, function (error, user) {
		if (error) {
			console.log(error);
		} else if (user) {
			usersRef.child(user.uid).set({username: user.username, pic: user.thirdPartyUserData.profile_image_url});
			currentUser = user;
		} else {
			//user is logged out
		}
	});


	//STEP 4: Display a list of users who have logged in
	usersRef.on("child_added", function (snapshot){
	var user = snapshot.val();
	$("<div id='user'><img src=" + user.pic + "/><span id='username'>@" + user.username + "</span></div>").appendTo($('#here'));

	});


	//STEP 5: Store messages in Firebase
	$('#tweet-submit').on('click', function () {
		if (currentUser != null) {
			var message = $('#msgInput').val();

			//Send the message to Firebase
			messagesRef.push({user: currentUser.uid, username: currentUser.username, message: message});

			$('#msgInput').val('');
		} else {
			alert('You must login with Twitter to post!');
		}
	});


	//STEP 6: Add messages to DOM in realtime
	messagesRef.on("child_added", function (snapshot) {
	  var message = snapshot.val(),
        safeMessage;

    safeMessage =
      $("<div class='msg-text'>@" +
        stripTags(message.username) +
        "<br/>" +
        stripTags(message.message) +
        "</div>");

    $('#stream').append(safeMessage);
	});

  function stripTags(str) {
    return str.replace(/(<([^>]+)>)/ig,"");
  }

</script>
</body>

</html>
